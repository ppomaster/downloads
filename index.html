<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>TV M3U Lite - Carregar por URL</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: #e0e0e0; color: #333; font-size: 14px; line-height: 1.3; }
  .header { background: #2e7d32; color: white; padding: 10px 5px; text-align: center; position: fixed; top: 0; width: 100%; z-index: 100; }
  .controls { background: white; padding: 8px 5px; position: fixed; top: 40px; width: 100%; z-index: 90; border-bottom: 1px solid #ccc; }
  .load-row { display: flex; gap: 5px; margin-bottom: 5px; }
  .load-row input { flex: 1; padding: 6px; border: 1px solid #ccc; font-size: 14px; }
  .load-row button { padding: 6px 12px; background: #2e7d32; color: white; border: none; border-radius: 3px; cursor: pointer; }
  .search-row { display: flex; gap: 5px; margin-bottom: 5px; }
  .search-row input { flex: 1; padding: 6px; border: 1px solid #ccc; font-size: 14px; }
  .search-row button { padding: 6px 12px; background: #2e7d32; color: white; border: none; border-radius: 3px; cursor: pointer; }
  .filter-row select { width: 100%; padding: 6px; border: 1px solid #ccc; font-size: 14px; }
  .content { margin-top: 140px; padding: 5px; }
  .category { background: white; margin-bottom: 12px; border-radius: 3px; overflow: hidden; }
  .category-header {
    padding: 8px;
    background: #f5f5f5;
    font-weight: bold;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .download-all-btn {
    background: #2e7d32;
    border: none;
    color: white;
    padding: 4px 10px;
    border-radius: 3px;
    font-size: 13px;
    cursor: pointer;
  }
  .items {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
  }
  .item {
    background: #fafafa;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    width: 180px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    background: #ddd;
  }
  .item-content {
    padding: 8px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .item-title {
    font-size: 14px;
    color: #2c3e50;
    margin-bottom: 8px;
    flex-grow: 1;
  }
  .item a, .item button {
    text-decoration: none;
  }
  .download-btn {
    background: #2e7d32;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    width: 100%;
    box-sizing: border-box;
  }
  .loading { text-align: center; padding: 20px; }
  .error { color: #d32f2f; text-align: center; padding: 10px; }
</style>
</head>
<body>

<div class="header">
  <h1 style="font-size: 18px; margin: 0;">TV M3U Lite</h1>
</div>

<div class="controls">
  <div class="load-row">
    <input type="text" id="m3uInput" placeholder="Digite URL ou caminho do arquivo M3U" value="https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts" />
    <button onclick="carregarListaDigitada()">Carregar Lista</button>
  </div>
  <div class="search-row">
    <input type="text" id="searchInput" placeholder="Pesquisar..." onkeypress="if(event.key=='Enter') pesquisar()" />
    <button onclick="pesquisar()">Buscar</button>
  </div>
  <div class="filter-row">
    <select id="categoryFilter" onchange="filtrarPorCategoria()">
      <option value="all">Todas categorias</option>
    </select>
  </div>
</div>

<div class="content">
  <div id="categories"></div>
  <div id="loading" class="loading" style="display:none;">Carregando lista...</div>
</div>

<script>
var allItems = [];
var categorias = {};
var categoriaAtual = 'all';

function carregarListaDigitada() {
  let url = document.getElementById('m3uInput').value.trim();
  if (!url) {
    alert('Por favor, digite uma URL ou caminho vÃ¡lido.');
    return;
  }
  carregarListaM3U(url);
}

function carregarListaM3U(url) {
  showLoading();
  fetch(url)
    .then(resp => {
      if (!resp.ok) throw new Error('Erro ao carregar a lista: ' + resp.statusText);
      return resp.text();
    })
    .then(text => {
      processarM3U(text);
      hideLoading();
    })
    .catch(e => {
      showError(e.message);
    });
}

function processarM3U(text) {
  allItems = [];
  categorias = {};
  let lines = text.split('\n');
  let currentItem = null;

  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();

    if (line.startsWith('#EXTINF:')) {
      currentItem = parseExtInf(line);
    } else if (currentItem && line && !line.startsWith('#') && (line.startsWith('http') || line.startsWith('file://'))) {
      currentItem.url = line;
      allItems.push(currentItem);

      if (!categorias[currentItem.categoria]) {
        categorias[currentItem.categoria] = [];
      }
      categorias[currentItem.categoria].push(currentItem);
      currentItem = null;
    }
  }

  preencherFiltroCategorias();
  filtrarPorCategoria();
}

function parseExtInf(line) {
  let item = { categoria: 'Geral', nome: '', url: '', capa: '' };

  let gtStart = line.indexOf('group-title="');
  if (gtStart > -1) {
    let gtEnd = line.indexOf('"', gtStart + 13);
    if (gtEnd > -1) {
      item.categoria = line.substring(gtStart + 13, gtEnd);
    }
  }
  let logoStart = line.indexOf('tvg-logo="');
  if (logoStart > -1) {
    let logoEnd = line.indexOf('"', logoStart + 9);
    if (logoEnd > -1) {
      item.capa = line.substring(logoStart + 9, logoEnd);
    }
  }
  let lastComma = line.lastIndexOf(',');
  if (lastComma > -1) {
    item.nome = line.substring(lastComma + 1).trim();
  }

  return item;
}

function preencherFiltroCategorias() {
  let select = document.getElementById('categoryFilter');
  while (select.options.length > 1) select.remove(1);
  let cats = Object.keys(categorias).sort();
  cats.forEach(cat => {
    let opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}

function filtrarPorCategoria() {
  categoriaAtual = document.getElementById('categoryFilter').value;
  renderizarCategorias();
}

function renderizarCategorias() {
  let container = document.getElementById('categories');
  container.innerHTML = '';

  let catsToShow = categoriaAtual === 'all' ? Object.keys(categorias) : [categoriaAtual];

  catsToShow.forEach(cat => {
    let items = categorias[cat] || [];
    if (items.length === 0) return;

    let catDiv = document.createElement('div');
    catDiv.className = 'category';

    let header = document.createElement('div');
    header.className = 'category-header';
    header.textContent = `${cat} (${items.length})`;

    let downloadAllBtn = document.createElement('button');
    downloadAllBtn.className = 'download-all-btn';
    downloadAllBtn.textContent = 'Baixar tudo';
    downloadAllBtn.onclick = () => baixarTodos(items);
    header.appendChild(downloadAllBtn);
    catDiv.appendChild(header);

    let itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';

    let count = Math.min(items.length, 8);
    for (let i = 0; i < count; i++) {
      itemsDiv.appendChild(createItemCard(items[i]));
    }

    if (items.length > 8) {
      let loadMore = document.createElement('div');
      loadMore.className = 'load-more';
      loadMore.innerHTML = `<button onclick="loadMoreItems(this, '${cat}', 8)">Carregar mais (${items.length - 8})</button>`;
      itemsDiv.appendChild(loadMore);
    }

    catDiv.appendChild(itemsDiv);
    container.appendChild(catDiv);
  });
}

function createItemCard(item) {
  let div = document.createElement('div');
  div.className = 'item';

  let img = document.createElement('img');
  img.src = item.capa || 'https://via.placeholder.com/300x150?text=Sem+Capa';
  img.alt = item.nome;
  div.appendChild(img);

  let contentDiv = document.createElement('div');
  contentDiv.className = 'item-content';
  contentDiv.style.padding = '6px';

  let title = document.createElement('div');
  title.className = 'item-title';
  title.textContent = item.nome;
  contentDiv.appendChild(title);

  let playLink = document.createElement('a');
  playLink.href = item.url;
  playLink.target = '_blank';
  playLink.textContent = 'Assistir';
  playLink.style.textDecoration = 'none';
  playLink.style.color = '#2e7d32';
  playLink.style.fontWeight = 'bold';
  playLink.style.marginRight = '6px';
  contentDiv.appendChild(playLink);

  let downloadBtn = document.createElement('button');
  downloadBtn.className = 'download-btn';
  downloadBtn.textContent = 'Download';
  downloadBtn.style.background = '#2e7d32';
  downloadBtn.style.color = '#fff';
  downloadBtn.style.border = 'none';
  downloadBtn.style.borderRadius = '3px';
  downloadBtn.style.padding = '6px 10px';
  downloadBtn.style.cursor = 'pointer';
  downloadBtn.onclick = () => baixarItem(item.url, item.nome);
  contentDiv.appendChild(downloadBtn);

  div.appendChild(contentDiv);

  return div;
}

function loadMoreItems(button, cat, offset) {
  let itemsDiv = button.parentElement;
  let items = categorias[cat];
  let nextItems = Math.min(items.length, offset + 8);

  for (let i = offset; i < nextItems; i++) {
    itemsDiv.insertBefore(createItemCard(items[i]), button);
  }

  if (nextItems >= items.length) {
    button.remove();
  } else {
    button.textContent = `Carregar mais (${items.length - nextItems})`;
    button.onclick = () => loadMoreItems(button, cat, nextItems);
  }
}

function pesquisar() {
  let query = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!query) {
    filtrarPorCategoria();
    return;
  }

  let container = document.getElementById('categories');
  container.innerHTML = '';

  let results = [];
  Object.values(categorias).forEach(catItems => {
    catItems.forEach(item => {
      if (item.nome.toLowerCase().includes(query)) {
        results.push(item);
      }
    });
  });

  if (results.length === 0) {
    container.innerHTML = '<div class="category">Nenhum resultado encontrado</div>';
    return;
  }

  let grouped = {};
  results.forEach(item => {
    if (!grouped[item.categoria]) grouped[item.categoria] = [];
    grouped[item.categoria].push(item);
  });

  for (let cat in grouped) {
    let catDiv = document.createElement('div');
    catDiv.className = 'category';

    let header = document.createElement('div');
    header.className = 'category-header';
    header.textContent = `${cat} (${grouped[cat].length})`;

    catDiv.appendChild(header);

    let itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';

    grouped[cat].forEach(item => {
      itemsDiv.appendChild(createItemCard(item));
    });

    catDiv.appendChild(itemsDiv);
    container.appendChild(catDiv);
  }
}

function baixarItem(url, nome) {
  let a = document.createElement('a');
  a.href = url;
  a.download = nome || 'arquivo';
  a.target = '_blank';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function baixarTodos(items) {
  if (!confirm(`Deseja baixar todos os ${items.length} itens desta categoria?`)) return;
  for (let item of items) {
    baixarItem(item.url, item.nome);
  }
}

function showLoading() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('categories').innerHTML = '';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(msg) {
  document.getElementById('loading').innerHTML = '<div class="error">' + msg + '</div>';
}
</script>

</body>
</html>

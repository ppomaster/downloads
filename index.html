<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DownStream Lite</title>
<style>
  body { margin: 0; padding: 0; font-family: Arial; background: #f0f0f0; color: #333; }
  header { background: #27ae60; color: white; padding: 8px; text-align: center; position: fixed; top: 0; width: 100%; }
  .controls { background: white; padding: 8px; position: fixed; top: 45px; width: 100%; border-bottom: 1px solid #ddd; }
  input, select, button { padding: 6px; font-size: 14px; border: 1px solid #ccc; margin-bottom: 5px; width: 100%; }
  button { background: #27ae60; color: white; border: none; }
  .content { margin-top: 120px; padding: 5px; }
  .category { background: white; margin-bottom: 5px; border: 1px solid #ddd; }
  .category-header { padding: 8px; font-weight: bold; }
  .items { display: none; border-top: 1px solid #ddd; }
  .item { padding: 8px; border-bottom: 1px solid #eee; }
  .item a { color: #2c3e50; text-decoration: none; display: block; }
  .loading { text-align: center; padding: 20px; }
  .error { color: red; text-align: center; padding: 10px; }
</style>
</head>
<body>

<header>
  <h1 style="margin:0;font-size:20px;">DownStream Lite</h1>
</header>

<div class="controls">
  <input type="text" id="search" placeholder="Pesquisar..." oninput="pesquisar()">
  <select id="categoryFilter" onchange="filtrarPorCategoria()">
    <option value="all">Todas categorias</option>
  </select>
</div>

<div class="content">
  <div id="categories"></div>
  <div id="loading" class="loading">Carregando...</div>
</div>

<script>
// URL da sua lista M3U
const M3U_URL = 'https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts';

// Variáveis globais
let allItems = [];
let categorias = {};
let categoriaAtual = 'all';
let itemsPorPagina = 10; // Apenas 10 itens por categoria inicialmente

// Carrega a lista M3U quando a página é carregada
window.addEventListener('load', function() {
  // Pequeno delay para permitir renderização inicial
  setTimeout(function() {
    carregarListaM3U();
  }, 300);
});

// Função para carregar a lista M3U
function carregarListaM3U() {
  // Mostra apenas loading
  document.getElementById('loading').style.display = 'block';
  document.getElementById('categories').innerHTML = '';
  
  // Usando uma requisição sincrona para economizar memória (não recomendado normalmente, mas necessário para dispositivos antigos)
  var xhr = new XMLHttpRequest();
  xhr.open('GET', M3U_URL, false); // Sincrono - cuidado com bloqueio de UI
  try {
    xhr.send();
    if (xhr.status === 200) {
      processarM3U(xhr.responseText);
    } else {
      document.getElementById('loading').innerHTML = '<div class="error">Erro ao carregar a lista</div>';
    }
  } catch (error) {
    document.getElementById('loading').innerHTML = '<div class="error">Erro de conexão</div>';
  }
}

// Função para processar o texto M3U
function processarM3U(m3uText) {
  var lines = m3uText.split('\n');
  allItems = [];
  categorias = {};
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    
    if (line.startsWith('#EXTINF:')) {
      // Extrai informações básicas da linha EXTINF (sem regex para performance)
      var groupTitle = 'Geral';
      var name = '';
      
      // Extrai group-title
      var groupIndex = line.indexOf('group-title="');
      if (groupIndex > -1) {
        var start = groupIndex + 13;
        var end = line.indexOf('"', start);
        if (end > -1) {
          groupTitle = line.substring(start, end);
        }
      }
      
      // Extrai o nome (está depois da última vírgula)
      var lastComma = line.lastIndexOf(',');
      if (lastComma > -1) {
        name = line.substring(lastComma + 1);
      }
      
      // A próxima linha deve ser a URL
      if (i + 1 < lines.length) {
        var url = lines[i + 1].trim();
        if (url && !url.startsWith('#') && url !== '') {
          allItems.push({
            categoria: groupTitle,
            nome: name,
            url: url
          });
          
          if (!categorias[groupTitle]) {
            categorias[groupTitle] = [];
          }
          categorias[groupTitle].push({
            nome: name,
            url: url
          });
          
          i++; // Pula a linha da URL
        }
      }
    }
  }
  
  // Preenche o seletor de categorias
  preencherSeletorCategorias();
  
  // Renderiza as categorias
  filtrarPorCategoria();
  
  // Esconde o loading
  document.getElementById('loading').style.display = 'none';
}

// Função para preencher o seletor de categorias
function preencherSeletorCategorias() {
  var select = document.getElementById('categoryFilter');
  // Mantém a opção "Todas as categorias"
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // Ordena categorias alfabeticamente
  var sortedCategories = Object.keys(categorias).sort();
  
  for (var i = 0; i < sortedCategories.length; i++) {
    var cat = sortedCategories[i];
    var option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  }
}

// Função para filtrar por categoria
function filtrarPorCategoria() {
  var select = document.getElementById('categoryFilter');
  categoriaAtual = select.value;
  renderizarCategorias();
}

// Função para renderizar categorias
function renderizarCategorias() {
  var container = document.getElementById('categories');
  container.innerHTML = '';
  
  if (Object.keys(categorias).length === 0) {
    container.innerHTML = '<div class="category">Nenhum canal encontrado</div>';
    return;
  }
  
  var categoriasParaRenderizar = {};
  
  if (categoriaAtual === 'all') {
    categoriasParaRenderizar = categorias;
  } else if (categorias[categoriaAtual]) {
    categoriasParaRenderizar[categoriaAtual] = categorias[categoriaAtual];
  }
  
  // Ordena categorias alfabeticamente
  var sortedCategories = Object.keys(categoriasParaRenderizar).sort();
  
  for (var i = 0; i < sortedCategories.length; i++) {
    var cat = sortedCategories[i];
    var items = categoriasParaRenderizar[cat];
    
    var catDiv = document.createElement('div');
    catDiv.className = 'category';
    
    var headerDiv = document.createElement('div');
    headerDiv.className = 'category-header';
    headerDiv.innerHTML = cat + ' (' + items.length + ')';
    
    var itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';
    itemsDiv.id = 'items-' + i;
    
    // Evento de clique para expandir/recolher
    headerDiv.onclick = (function(div) {
      return function() {
        div.style.display = div.style.display === 'block' ? 'none' : 'block';
      };
    })(itemsDiv);
    
    // Adiciona apenas alguns itens inicialmente para performance
    var maxItemsToShow = Math.min(items.length, itemsPorPagina);
    for (var j = 0; j < maxItemsToShow; j++) {
      var it = items[j];
      var itemDiv = document.createElement('div');
      itemDiv.className = 'item';
      itemDiv.innerHTML = '<a href="' + it.url + '">' + it.nome + '</a>';
      itemsDiv.appendChild(itemDiv);
    }
    
    // Se houver mais itens, adiciona um botão para carregar mais
    if (items.length > itemsPorPagina) {
      var moreButton = document.createElement('button');
      moreButton.textContent = 'Carregar mais (' + (items.length - itemsPorPagina) + ')';
      moreButton.onclick = (function(allItems, container, cat) {
        return function() {
          for (var k = itemsPorPagina; k < allItems.length; k++) {
            var it = allItems[k];
            if (it.categoria === cat) {
              var itemDiv = document.createElement('div');
              itemDiv.className = 'item';
              itemDiv.innerHTML = '<a href="' + it.url + '">' + it.nome + '</a>';
              container.appendChild(itemDiv);
            }
          }
          this.style.display = 'none';
        };
      })(allItems, itemsDiv, cat);
      itemsDiv.appendChild(moreButton);
    }
    
    catDiv.appendChild(headerDiv);
    catDiv.appendChild(itemsDiv);
    container.appendChild(catDiv);
  }
}

// Função de pesquisa
function pesquisar() {
  var query = document.getElementById('search').value.toLowerCase().trim();
  
  if (!query) {
    // Se não há pesquisa, mostra todos os itens
    var items = document.querySelectorAll('.item');
    for (var i = 0; i < items.length; i++) {
      items[i].style.display = 'block';
    }
    return;
  }
  
  // Filtra os itens
  var items = document.querySelectorAll('.item');
  for (var i = 0; i < items.length; i++) {
    var itemText = items[i].textContent.toLowerCase();
    items[i].style.display = itemText.indexOf(query) > -1 ? 'block' : 'none';
  }
}
</script>

</body>
</html>
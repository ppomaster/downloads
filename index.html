<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DownStream - M3U Leve</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #f0f0f0; 
    margin: 0; 
    padding: 0; 
    font-size: 14px; 
  }
  header { 
    background: #27ae60; 
    color: white; 
    padding: 10px; 
    text-align: center; 
    position: fixed; 
    top: 0; 
    width: 100%; 
    z-index: 100; 
  }
  .controls { 
    background: #fff; 
    padding: 8px; 
    position: fixed; 
    top: 70px; 
    width: 100%; 
    z-index: 90; 
    border-bottom: 1px solid #ddd; 
  }
  .search-box { 
    margin-bottom: 5px; 
  }
  input, select, button { 
    padding: 6px; 
    font-size: 14px; 
    border: 1px solid #ccc; 
    width: 100%; 
    margin-bottom: 5px; 
  }
  button { 
    background: #27ae60; 
    color: white; 
    border: none; 
  }
  .content { 
    margin-top: 130px; 
    padding: 5px; 
  }
  .category { 
    background: white; 
    margin-bottom: 5px; 
    border: 1px solid #ddd; 
    border-radius: 3px; 
  }
  .category-header { 
    padding: 8px; 
    font-weight: bold; 
    display: flex; 
    justify-content: space-between; 
  }
  .items { 
    display: none; 
    border-top: 1px solid #ddd; 
  }
  .item { 
    padding: 8px; 
    border-bottom: 1px solid #eee; 
  }
  .item:last-child { 
    border-bottom: none; 
  }
  .item a { 
    color: #2c3e50; 
    text-decoration: none; 
    display: block; 
  }
  .loading { 
    text-align: center; 
    padding: 20px; 
  }
  .error { 
    color: red; 
    text-align: center; 
    padding: 10px; 
  }
</style>
</head>
<body>

<header>
  <h1>DownStream</h1>
</header>

<div class="controls">
  <div class="search-box">
    <input type="text" id="search" placeholder="Pesquisar..." oninput="pesquisar()">
  </div>
  <select id="categoryFilter" onchange="filtrarPorCategoria()">
    <option value="all">Todas categorias</option>
  </select>
</div>

<div class="content">
  <div id="categories"></div>
  <div id="loading" class="loading">Carregando...</div>
</div>

<script>
// URL da sua lista M3U
const M3U_URL = 'https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts';

// Variáveis globais
let allItems = [];
let categorias = {};
let categoriaAtual = 'all';

// Carrega a lista M3U quando a página é carregada
window.addEventListener('load', function() {
  setTimeout(carregarListaM3U, 100); // Pequeno delay para permitir renderização inicial
});

// Função para carregar a lista M3U
function carregarListaM3U() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', M3U_URL, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        processarM3U(xhr.responseText);
        document.getElementById('loading').style.display = 'none';
      } else {
        document.getElementById('loading').innerHTML = 
          '<div class="error">Erro ao carregar a lista</div>';
      }
    }
  };
  xhr.send();
}

// Função para processar o texto M3U
function processarM3U(m3uText) {
  var lines = m3uText.split('\n');
  allItems = [];
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    
    if (line.startsWith('#EXTINF:')) {
      // Extrai informações da linha EXTINF
      var info = parseExtInf(line);
      
      // A próxima linha deve ser a URL
      if (i + 1 < lines.length) {
        var url = lines[i + 1].trim();
        if (url && !url.startsWith('#') && url !== '') {
          allItems.push({
            categoria: info.groupTitle || 'Geral',
            nome: info.name,
            url: url
          });
          i++; // Pula a linha da URL
        }
      }
    }
  }
  
  // Agrupa por categoria
  categorias = {};
  for (var j = 0; j < allItems.length; j++) {
    var item = allItems[j];
    if (!categorias[item.categoria]) {
      categorias[item.categoria] = [];
    }
    categorias[item.categoria].push(item);
  }
  
  // Preenche o seletor de categorias
  preencherSeletorCategorias();
  
  // Renderiza as categorias
  filtrarPorCategoria();
}

// Função para preencher o seletor de categorias
function preencherSeletorCategorias() {
  var select = document.getElementById('categoryFilter');
  // Mantém a opção "Todas as categorias"
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // Ordena categorias alfabeticamente
  var sortedCategories = Object.keys(categorias).sort();
  
  for (var k = 0; k < sortedCategories.length; k++) {
    var cat = sortedCategories[k];
    var option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  }
}

// Função para filtrar por categoria
function filtrarPorCategoria() {
  var select = document.getElementById('categoryFilter');
  categoriaAtual = select.value;
  renderizarCategorias();
}

// Função para renderizar categorias
function renderizarCategorias() {
  var container = document.getElementById('categories');
  container.innerHTML = '';
  
  if (Object.keys(categorias).length === 0) {
    container.innerHTML = '<div class="category">Nenhum canal encontrado</div>';
    return;
  }
  
  var categoriasParaRenderizar = {};
  
  if (categoriaAtual === 'all') {
    categoriasParaRenderizar = categorias;
  } else if (categorias[categoriaAtual]) {
    categoriasParaRenderizar[categoriaAtual] = categorias[categoriaAtual];
  }
  
  // Ordena categorias alfabeticamente
  var sortedCategories = Object.keys(categoriasParaRenderizar).sort();
  
  for (var l = 0; l < sortedCategories.length; l++) {
    var cat = sortedCategories[l];
    var items = categoriasParaRenderizar[cat];
    
    var catDiv = document.createElement('div');
    catDiv.className = 'category';
    
    var headerDiv = document.createElement('div');
    headerDiv.className = 'category-header';
    headerDiv.innerHTML = '<span>' + cat + '</span><span>(' + items.length + ')</span>';
    
    var itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';
    itemsDiv.id = 'items-' + l;
    
    // Evento de clique para expandir/recolher
    headerDiv.addEventListener('click', (function(div) {
      return function() {
        var currentDisplay = div.style.display;
        div.style.display = currentDisplay === 'block' ? 'none' : 'block';
      };
    })(itemsDiv));
    
    // Adiciona apenas 5 itens inicialmente para performance
    var maxItemsToShow = Math.min(items.length, 5);
    for (var m = 0; m < maxItemsToShow; m++) {
      var it = items[m];
      var itemDiv = document.createElement('div');
      itemDiv.className = 'item';
      itemDiv.innerHTML = '<a href="' + it.url + '" target="_blank">' + it.nome + '</a>';
      itemsDiv.appendChild(itemDiv);
    }
    
    // Se houver mais itens, adiciona um botão para carregar mais
    if (items.length > 5) {
      var moreButton = document.createElement('button');
      moreButton.textContent = 'Carregar mais (' + (items.length - 5) + ')';
      moreButton.onclick = (function(allItems, container) {
        return function() {
          for (var n = 5; n < allItems.length; n++) {
            var it = allItems[n];
            var itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            itemDiv.innerHTML = '<a href="' + it.url + '" target="_blank">' + it.nome + '</a>';
            container.appendChild(itemDiv);
          }
          this.style.display = 'none';
        };
      })(items, itemsDiv);
      itemsDiv.appendChild(moreButton);
    }
    
    catDiv.appendChild(headerDiv);
    catDiv.appendChild(itemsDiv);
    container.appendChild(catDiv);
  }
}

// Função para parsear a linha EXTINF
function parseExtInf(line) {
  var result = {
    name: '',
    groupTitle: 'Geral'
  };
  
  // Extrai o nome (está depois da última vírgula)
  var lastComma = line.lastIndexOf(',');
  if (lastComma !== -1) {
    result.name = line.substring(lastComma + 1);
  }
  
  // Extrai group-title se existir
  var groupTitleMatch = line.match(/group-title="([^"]*)"/);
  if (groupTitleMatch && groupTitleMatch[1]) {
    result.groupTitle = groupTitleMatch[1];
  }
  
  return result;
}

// Função de pesquisa
function pesquisar() {
  var query = document.getElementById('search').value.toLowerCase().trim();
  
  // Filtra as categorias visíveis com base na pesquisa
  var categoriasVisiveis = document.querySelectorAll('#categories > .category');
  
  for (var i = 0; i < categoriasVisiveis.length; i++) {
    var catDiv = categoriasVisiveis[i];
    var itemsDiv = catDiv.querySelector('.items');
    var items = itemsDiv.querySelectorAll('.item');
    
    var hasVisibleItems = false;
    
    for (var j = 0; j < items.length; j++) {
      var itemText = items[j].textContent.toLowerCase();
      if (itemText.indexOf(query) > -1) {
        items[j].style.display = 'block';
        hasVisibleItems = true;
      } else {
        items[j].style.display = 'none';
      }
    }
    
    // Mostra ou esconde a categoria baseado se tem itens visíveis
    catDiv.style.display = hasVisibleItems ? 'block' : 'none';
  }
}
</script>

</body>
</html>
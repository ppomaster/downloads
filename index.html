<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TV M3U Lite</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: #e0e0e0; color: #333; font-size: 14px; line-height: 1.3; }
  .header { background: #2e7d32; color: white; padding: 10px 5px; text-align: center; position: fixed; top: 0; width: 100%; z-index: 100; }
  .controls { background: white; padding: 8px 5px; position: fixed; top: 40px; width: 100%; z-index: 90; border-bottom: 1px solid #ccc; }
  .search-row { display: flex; gap: 5px; margin-bottom: 5px; }
  .search-row input { flex: 1; padding: 6px; border: 1px solid #ccc; font-size: 14px; }
  .search-row button { padding: 6px 12px; background: #2e7d32; color: white; border: none; border-radius: 3px; }
  .filter-row select { width: 100%; padding: 6px; border: 1px solid #ccc; font-size: 14px; }
  .content { margin-top: 110px; padding: 5px; }
  .category { background: white; margin-bottom: 4px; border-radius: 3px; overflow: hidden; }
  .category-header { padding: 8px; background: #f5f5f5; font-weight: bold; border-bottom: 1px solid #eee; }
  .items { display: none; }
  .item { padding: 8px; border-bottom: 1px solid #f0f0f0; }
  .item:last-child { border-bottom: none; }
  .item a { color: #2c3e50; text-decoration: none; display: block; }
  .load-more { padding: 8px; text-align: center; background: #f9f9f9; }
  .load-more button { padding: 6px 12px; background: #2e7d32; color: white; border: none; border-radius: 3px; }
  .loading { text-align: center; padding: 20px; }
  .error { color: #d32f2f; text-align: center; padding: 10px; }
</style>
</head>
<body>

<div class="header">
  <h1 style="font-size: 18px; margin: 0;">TV M3U Lite</h1>
</div>

<div class="controls">
  <div class="search-row">
    <input type="text" id="searchInput" placeholder="Pesquisar..." onkeypress="if(event.key=='Enter')pesquisar()">
    <button onclick="pesquisar()">Buscar</button>
  </div>
  <div class="filter-row">
    <select id="categoryFilter" onchange="filtrarPorCategoria()">
      <option value="all">Todas categorias</option>
    </select>
  </div>
</div>

<div class="content">
  <div id="categories"></div>
  <div id="loading" class="loading">Carregando lista...</div>
</div>

<script>
// Configurações
const M3U_URL = 'https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts';
const ITEMS_PER_PAGE = 8; // Reduzido para melhor performance

// Variáveis globais mínimas
var allItems = [];
var categorias = {};
var categoriaAtual = 'all';

// Inicialização
window.addEventListener('load', function() {
  setTimeout(carregarListaM3U, 100);
});

// Carregar lista M3U
function carregarListaM3U() {
  showLoading();
  
  var xhr = new XMLHttpRequest();
  xhr.open('GET', M3U_URL);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        processarM3U(xhr.responseText);
        hideLoading();
      } else {
        showError('Erro ao carregar');
      }
    }
  };
  xhr.send();
}

// Processar conteúdo M3U
function processarM3U(text) {
  allItems = [];
  categorias = {};
  
  var lines = text.split('\n');
  var currentItem = null;
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    
    if (line.startsWith('#EXTINF:')) {
      currentItem = parseExtInf(line);
    } 
    else if (currentItem && line && !line.startsWith('#') && line.startsWith('http')) {
      currentItem.url = line;
      allItems.push(currentItem);
      
      if (!categorias[currentItem.categoria]) {
        categorias[currentItem.categoria] = [];
      }
      categorias[currentItem.categoria].push(currentItem);
      
      currentItem = null;
    }
  }
  
  preencherFiltroCategorias();
  filtrarPorCategoria();
}

// Parse simples de EXTINF
function parseExtInf(line) {
  var item = { categoria: 'Geral', nome: '', url: '' };
  
  // Extrair group-title
  var gtStart = line.indexOf('group-title="');
  if (gtStart > -1) {
    var gtEnd = line.indexOf('"', gtStart + 13);
    if (gtEnd > -1) {
      item.categoria = line.substring(gtStart + 13, gtEnd);
    }
  }
  
  // Extrair nome
  var lastComma = line.lastIndexOf(',');
  if (lastComma > -1) {
    item.nome = line.substring(lastComma + 1).trim();
  }
  
  return item;
}

// Preencher filtro de categorias
function preencherFiltroCategorias() {
  var select = document.getElementById('categoryFilter');
  while (select.options.length > 1) select.remove(1);
  
  var cats = Object.keys(categorias).sort();
  for (var i = 0; i < cats.length; i++) {
    var opt = document.createElement('option');
    opt.value = cats[i];
    opt.textContent = cats[i];
    select.appendChild(opt);
  }
}

// Filtrar por categoria
function filtrarPorCategoria() {
  categoriaAtual = document.getElementById('categoryFilter').value;
  renderizarCategorias();
}

// Renderizar categorias
function renderizarCategorias() {
  var container = document.getElementById('categories');
  container.innerHTML = '';
  
  var catsToShow = categoriaAtual === 'all' ? Object.keys(categorias) : [categoriaAtual];
  
  for (var i = 0; i < catsToShow.length; i++) {
    var cat = catsToShow[i];
    var items = categorias[cat] || [];
    
    if (items.length === 0) continue;
    
    var catDiv = createCategoryDiv(cat, items);
    container.appendChild(catDiv);
  }
}

// Criar div de categoria
function createCategoryDiv(cat, items) {
  var div = document.createElement('div');
  div.className = 'category';
  
  var header = document.createElement('div');
  header.className = 'category-header';
  header.innerHTML = cat + ' (' + items.length + ')';
  header.onclick = function() {
    var itemsDiv = this.nextElementSibling;
    itemsDiv.style.display = itemsDiv.style.display === 'block' ? 'none' : 'block';
  };
  
  var itemsDiv = document.createElement('div');
  itemsDiv.className = 'items';
  
  // Adicionar itens iniciais
  var count = Math.min(items.length, ITEMS_PER_PAGE);
  for (var i = 0; i < count; i++) {
    itemsDiv.appendChild(createItemDiv(items[i]));
  }
  
  // Botão carregar mais se necessário
  if (items.length > ITEMS_PER_PAGE) {
    var loadMore = document.createElement('div');
    loadMore.className = 'load-more';
    loadMore.innerHTML = '<button onclick="loadMoreItems(this, \'' + cat + '\', ' + ITEMS_PER_PAGE + ')">Carregar mais (' + (items.length - ITEMS_PER_PAGE) + ')</button>';
    itemsDiv.appendChild(loadMore);
  }
  
  div.appendChild(header);
  div.appendChild(itemsDiv);
  return div;
}

// Criar div de item
function createItemDiv(item) {
  var div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = '<a href="' + item.url + '" target="_blank">' + item.nome + '</a>';
  return div;
}

// Carregar mais itens
function loadMoreItems(button, cat, offset) {
  var itemsDiv = button.parentElement.parentElement;
  var items = categorias[cat];
  
  for (var i = offset; i < Math.min(items.length, offset + ITEMS_PER_PAGE); i++) {
    itemsDiv.insertBefore(createItemDiv(items[i]), button.parentElement);
  }
  
  if (i >= items.length) {
    button.parentElement.remove();
  } else {
    button.textContent = 'Carregar mais (' + (items.length - i) + ')';
    button.onclick = function() { loadMoreItems(this, cat, i); };
  }
}

// Pesquisar
function pesquisar() {
  var query = document.getElementById('searchInput').value.toLowerCase().trim();
  
  if (!query) {
    filtrarPorCategoria();
    return;
  }
  
  var container = document.getElementById('categories');
  container.innerHTML = '';
  
  var results = [];
  for (var cat in categorias) {
    for (var i = 0; i < categorias[cat].length; i++) {
      var item = categorias[cat][i];
      if (item.nome.toLowerCase().includes(query)) {
        results.push(item);
      }
    }
  }
  
  if (results.length === 0) {
    container.innerHTML = '<div class="category">Nenhum resultado encontrado</div>';
    return;
  }
  
  // Agrupar resultados por categoria
  var grouped = {};
  for (var i = 0; i < results.length; i++) {
    var cat = results[i].categoria;
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(results[i]);
  }
  
  // Mostrar resultados
  for (var cat in grouped) {
    var catDiv = createCategoryDiv(cat, grouped[cat]);
    // Expandir automaticamente os resultados de pesquisa
    catDiv.querySelector('.items').style.display = 'block';
    container.appendChild(catDiv);
  }
}

// Utilitários
function showLoading() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('categories').innerHTML = '';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(msg) {
  document.getElementById('loading').innerHTML = '<div class="error">' + msg + '</div>';
}
</script>

</body>
</html> 
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DownStream - Sua M3U na Mão</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
  header { padding: 1rem; background: #27ae60; color: white; text-align: center; position: sticky; top: 0; z-index: 10; }
  .container { padding: 0.5rem; }
  .controls { padding: 0.5rem; background: white; position: sticky; top: 68px; z-index: 9; display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .search-box { flex: 1; min-width: 150px; }
  .search-box input { width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ddd; }
  .category-filter { flex: 1; min-width: 150px; }
  .category-filter select { width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ddd; }
  button { padding: 0.5rem; font-size: 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; }
  .category { padding: 0.75rem; background: white; margin-bottom: 0.25rem; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; }
  .category:hover { background: #ecf0f1; }
  .items { display: none; background: #f9f9f9; }
  .item { padding: 0.75rem; border-bottom: 1px solid #eee; }
  .item a { text-decoration: none; color: #2c3e50; display: block; }
  .loading { text-align: center; padding: 2rem; }
  .error { color: red; text-align: center; padding: 1rem; }
  .empty { text-align: center; padding: 1rem; color: #777; }
  .category-name { font-weight: bold; }
  .category-count { background: #27ae60; color: white; border-radius: 12px; padding: 0 8px; font-size: 0.8rem; }
</style>
</head>
<body>

<header>
  <h1>DownStream</h1>
  <p>Sua lista M3U carregada!</p>
</header>

<div class="container">
  <div class="controls">
    <div class="search-box">
      <input type="text" id="search" placeholder="Pesquisar canais..." onkeyup="pesquisar()">
    </div>
    <div class="category-filter">
      <select id="categoryFilter" onchange="filtrarPorCategoria()">
        <option value="all">Todas as categorias</option>
      </select>
    </div>
    <button onclick="carregarListaM3U()">Recarregar</button>
  </div>
  
  <div id="categories"></div>
  <div id="loading" class="loading">Carregando lista, aguarde...</div>
</div>

<script>
// URL da sua lista M3U
const M3U_URL = 'https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts';

// Variáveis globais
let allItems = [];
let categorias = {};
let categoriaAtual = 'all';

// Carrega a lista M3U quando a página é carregada
window.addEventListener('DOMContentLoaded', () => {
  carregarListaM3U();
});

// Função para carregar a lista M3U
async function carregarListaM3U() {
  try {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('categories').innerHTML = '';
    
    const response = await fetch(M3U_URL);
    if (!response.ok) {
      throw new Error('Erro ao carregar a lista');
    }
    
    const m3uText = await response.text();
    processarM3U(m3uText);
    document.getElementById('loading').style.display = 'none';
  } catch (error) {
    document.getElementById('loading').innerHTML = 
      `<div class="error">Erro ao carregar a lista: ${error.message}</div>`;
  }
}

// Função para processar o texto M3U
function processarM3U(m3uText) {
  const lines = m3uText.split('\n');
  allItems = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('#EXTINF:')) {
      // Extrai informações da linha EXTINF
      const info = parseExtInf(line);
      
      // A próxima linha deve ser a URL
      if (i + 1 < lines.length) {
        const url = lines[i + 1].trim();
        if (url && !url.startsWith('#') && url !== '') {
          allItems.push({
            categoria: info.groupTitle || 'Geral',
            nome: info.name,
            url: url
          });
          i++; // Pula a linha da URL
        }
      }
    }
  }
  
  // Agrupa por categoria
  categorias = {};
  allItems.forEach(item => {
    if (!categorias[item.categoria]) {
      categorias[item.categoria] = [];
    }
    categorias[item.categoria].push(item);
  });
  
  // Preenche o seletor de categorias
  preencherSeletorCategorias();
  
  // Renderiza as categorias
  filtrarPorCategoria();
}

// Função para preencher o seletor de categorias
function preencherSeletorCategorias() {
  const select = document.getElementById('categoryFilter');
  // Mantém a opção "Todas as categorias"
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // Ordena categorias alfabeticamente
  const sortedCategories = Object.keys(categorias).sort();
  
  for (const cat of sortedCategories) {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  }
}

// Função para filtrar por categoria
function filtrarPorCategoria() {
  const select = document.getElementById('categoryFilter');
  categoriaAtual = select.value;
  renderizarCategorias();
}

// Função para renderizar categorias
function renderizarCategorias() {
  const container = document.getElementById('categories');
  container.innerHTML = '';
  
  if (Object.keys(categorias).length === 0) {
    container.innerHTML = '<div class="empty">Nenhum canal encontrado</div>';
    return;
  }
  
  let categoriasParaRenderizar = {};
  
  if (categoriaAtual === 'all') {
    categoriasParaRenderizar = {...categorias};
  } else if (categorias[categoriaAtual]) {
    categoriasParaRenderizar[categoriaAtual] = categorias[categoriaAtual];
  }
  
  // Ordena categorias alfabeticamente
  const sortedCategories = Object.keys(categoriasParaRenderizar).sort();
  
  for (const cat of sortedCategories) {
    const items = categoriasParaRenderizar[cat];
    
    const catDiv = document.createElement('div');
    catDiv.className = 'category';
    catDiv.innerHTML = `
      <span class="category-name">${cat}</span>
      <span class="category-count">${items.length}</span>
    `;
    
    const itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';
    itemsDiv.id = `items-${cat.replace(/\s+/g, '-')}`;
    
    // Adiciona os itens
    items.forEach(it => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'item';
      itemDiv.innerHTML = `<a href="${it.url}" target="_blank">${it.nome}</a>`;
      itemsDiv.appendChild(itemDiv);
    });
    
    // Evento de clique para expandir/recolher
    catDiv.addEventListener('click', () => {
      const isVisible = itemsDiv.style.display === 'block';
      itemsDiv.style.display = isVisible ? 'none' : 'block';
    });
    
    container.appendChild(catDiv);
    container.appendChild(itemsDiv);
  }
}

// Função para parsear a linha EXTINF
function parseExtInf(line) {
  const result = {
    name: '',
    groupTitle: 'Geral'
  };
  
  // Extrai o nome (está depois da última vírgula)
  const lastComma = line.lastIndexOf(',');
  if (lastComma !== -1) {
    result.name = line.substring(lastComma + 1);
  }
  
  // Extrai group-title se existir
  const groupTitleMatch = line.match(/group-title="([^"]*)"/);
  if (groupTitleMatch && groupTitleMatch[1]) {
    result.groupTitle = groupTitleMatch[1];
  }
  
  // Tenta extrair o nome de tvg-name se o nome estiver vazio
  if (!result.name || result.name.trim() === '') {
    const tvgNameMatch = line.match(/tvg-name="([^"]*)"/);
    if (tvgNameMatch && tvgNameMatch[1]) {
      result.name = tvgNameMatch[1];
    }
  }
  
  return result;
}

// Função de pesquisa
function pesquisar() {
  const query = document.getElementById('search').value.toLowerCase().trim();
  
  // Filtra as categorias visíveis com base na pesquisa
  const categoriasVisiveis = document.querySelectorAll('#categories > .category');
  
  categoriasVisiveis.forEach(catDiv => {
    const catName = catDiv.querySelector('.category-name').textContent;
    const itemsDiv = document.getElementById(`items-${catName.replace(/\s+/g, '-')}`);
    const items = itemsDiv.getElementsByClassName('item');
    
    let hasVisibleItems = false;
    
    for (let i = 0; i < items.length; i++) {
      const itemText = items[i].textContent.toLowerCase();
      if (itemText.includes(query)) {
        items[i].style.display = 'block';
        hasVisibleItems = true;
      } else {
        items[i].style.display = 'none';
      }
    }
    
    // Mostra ou esconde a categoria baseado se tem itens visíveis
    catDiv.style.display = hasVisibleItems ? 'flex' : 'none';
    itemsDiv.style.display = hasVisibleItems ? 'block' : 'none';
  });
}
</script>

</body>
</html>
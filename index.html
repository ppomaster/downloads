<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>IPTV VOD Organizado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: linear-gradient(135deg,#0e375a 60%,#183c67 100%); min-height:100vh; margin:0; color:#eaf5ff; font-family: Arial,sans-serif; }
    .iptv-area { max-width:520px; margin:32px auto; padding:22px; background:#121f37e0; border-radius:16px; }
    .iptv-btn  { padding:12px 27px;background:#19a8ff;color:#fff;border:none;border-radius:7px;font-size:1.08rem;font-weight:600;cursor:pointer;margin-bottom:13px;}
    .iptv-categoria-bloco { margin-bottom:22px; padding-bottom:8px; border-bottom:1px solid #3777ad20;}
    .iptv-cat-titulo { font-size:1.18rem;background:#19a8ff33;color:#fff;margin-bottom:7px;
      padding:9px 13px; border-radius:7px; font-weight:600;}
    .iptv-list { margin-bottom:8px; }
    .iptv-item { background:#183968cc;border-radius:7px;padding:11px 9px;margin-bottom:8px;font-weight:480;
        display:flex;align-items:center;justify-content:space-between;}
    .iptv-name { font-size:1.07rem;cursor:pointer;color:#fff;}
    .iptv-name:hover { color:#40e5ff;text-decoration:underline;}
    .iptv-player {background:#1d324c;padding:17px 5px;margin-top:18px; border-radius:9px;}
    .iptv-modal {position:fixed;top:0;left:0;width:100vw;height:100vh;background:#111f3485;display:none;align-items:center;justify-content:center;z-index:90;}
    .iptv-modal-content { background:#fff; color:#153e74; border-radius:13px; max-width:350px; padding:22px 14px; font-size:1.03rem; box-shadow:0 4px 22px #022;}
    .iptv-modal img { max-width:92%;max-height:165px;border-radius:9px;margin-bottom:8px;}
    .iptv-modal .iptv-close, .iptv-modal .iptv-watch { padding:7px 16px;border:none;border-radius:6px;margin-top:11px; font-size:1rem; font-weight:600;cursor:pointer;}
    .iptv-modal .iptv-close { background:#19a8ff;color:#fff;float:right;}
    .iptv-modal .iptv-watch { background:#198b54;color:#fff;float:left;}
    @media (max-width:600px){.iptv-area{padding:4vw;}.iptv-item{font-size:0.99rem;}}
  </style>
</head>
<body>
  <div class="iptv-area">
    <div style="font-size:1.19rem;margin-bottom:16px;">IPTV VOD Organizado</div>
    <button class="iptv-btn" onclick="carregarM3U()">CARREGAR LISTA</button>
    <div id="iptvCategoriasTitulos"></div>
    <div id="iptvPlayer"></div>
  </div>
  <div class="iptv-modal" id="iptvModal"><div class="iptv-modal-content" id="iptvModalContent"></div></div>
  <script>
    // Sua lista já preenchida e API correta
    const M3U_URL = "https://cdnvisionplay.xyz/get.php?username=839035601&password=584869&type=m3u_plus&output=mpegts";
    const OMDB_KEY = "6cbfb854";
    let M3U_LISTA = [], M3U_CATEGORIAS = [];

    function carregarM3U() {
      document.getElementById("iptvPlayer").innerHTML = '';
      document.getElementById("iptvCategoriasTitulos").innerHTML = `<div style="color:#2acefc;padding:15px;">Carregando lista...</div>`;
      fetch(M3U_URL)
      .then(r=>r.text())
      .then(txt=>{
          M3U_LISTA=[]; let cats = {};
          let cur = null;
          txt.split('\n').forEach(l=>{
              l=l.trim();
              if(l.startsWith('#EXTINF:')) {
                  cur={categoria:'Sem Categoria',nome:'',url:''};
                  let gtm = l.match(/group-title="([^"]+)"/i);
                  if (gtm) cur.categoria = gtm[1].trim();
                  let nome = l.split(','); cur.nome = nome[nome.length-1].trim();
              } else if(cur && l && !l.startsWith('#')) {
                  cur.url=l; M3U_LISTA.push(cur);
                  if(!cats[cur.categoria.toLowerCase()]) cats[cur.categoria.toLowerCase()]=cur.categoria;
                  cur=null;
              }
          });
          M3U_CATEGORIAS = Object.values(cats).sort((a,b)=>a.localeCompare(b));
          mostrarCategoriasETitulos();
      })
      .catch(()=>document.getElementById("iptvCategoriasTitulos").innerHTML = `<div style="color:#ff7575;">Falha ao carregar lista.</div>`);
    }

    function mostrarCategoriasETitulos() {
      let html = "";
      M3U_CATEGORIAS.forEach(cat=>{
        const lista = M3U_LISTA.filter(it => it.categoria.trim().toLowerCase() === cat.trim().toLowerCase());
        if(!lista.length) return;
        html+=`<div class="iptv-categoria-bloco">
          <div class="iptv-cat-titulo">${cat}</div>
          <div class="iptv-list">`;
        lista.forEach(it=>{
          html+=`
            <div class='iptv-item'>
              <span class='iptv-name' onclick="modalInfo('${escapeStr(it.nome)}','${escapeStr(it.url)}')">${it.nome}</span>
              <button onclick="tocarStream('${escapeStr(it.url)}','${escapeStr(it.nome)}',this)"
                  style="background:#19a8ff;color:#fff;border:none;padding:7px 16px;border-radius:6px;font-size:1.07rem;">▶</button>
            </div>
          `;
        });
        html+=`</div></div>`;
      });
      document.getElementById("iptvCategoriasTitulos").innerHTML=html || "<div style='color:#fe9;'>Nenhuma categoria encontrada.</div>";
      document.getElementById("iptvPlayer").innerHTML='';
    }
    function escapeStr(str){ return (str||"").replace(/'/g,"").replace(/"/g,"").replace(/\\/g,""); }

    function tocarStream(url, nome, btn) {
      document.getElementById("iptvPlayer").innerHTML = `
          <div class='iptv-player'><b style="color:#54bae2;">${nome||""}</b><br>
          <video controls autoplay muted style="width:98%;max-height:41vh;background:#000;border-radius:8px;margin-top:9px;">
              <source src="${url}">
              Seu navegador/device não suportou este formato.
          </video></div>`;
      window.scrollTo(0,document.getElementById("iptvPlayer").offsetTop-58);
    }

    // MELHORIA: tenta buscar nome “limpo” no OMDb se não achar de primeira
    function limparNomeOMDB(nome) {
      // Remove prefixos comuns (24H, FHD, SD, HD, [FILME], etc)
      return nome.replace(/^(24H|FHD|HD|SD|\[FILME\]|\[SERIE\]|\[.*?\])/i, '')
                 .replace(/^[^a-zA-Z0-9]+/, '')
                 .replace(/ +$/, '')
                 .replace(/ +/g, ' ')
                 .trim();
    }
    function modalInfo(nome,url){
      const modal = document.getElementById("iptvModal");
      const modalC = document.getElementById("iptvModalContent");
      modal.style.display="flex";
      modalC.innerHTML="<div style='color:#18b7fe;'>Buscando informações...</div>";
      fetch(`https://www.omdbapi.com/?apikey=${OMDB_KEY}&t=${encodeURIComponent(nome)}`)
        .then(r=>r.json())
        .then(data=>{
            // Se não encontrou, tenta nome limpo
            if(data && data.Response==="False") {
              const nomeLimpo = limparNomeOMDB(nome);
              if(nomeLimpo.toLowerCase()!==nome.toLowerCase())
                return fetch(`https://www.omdbapi.com/?apikey=${OMDB_KEY}&t=${encodeURIComponent(nomeLimpo)}`)
                  .then(r2=>r2.json())
                  .then(data2=>{return mostrarModalOMDB(data2,nome,url,modalC);});
            }
            mostrarModalOMDB(data, nome, url, modalC);
        })
        .catch(()=>{
            modalC.innerHTML = `<b>${nome}</b><br>
                <div style="color:#e44;">Erro ao buscar informações.</div>
                <button class="iptv-close" onclick="document.getElementById('iptvModal').style.display='none';">FECHAR</button>`;
        });
    }
    function mostrarModalOMDB(data, nome, url, el) {
      if(data && data.Response==="True"){
          el.innerHTML = `<img src="${data.Poster}" alt="Poster"/>
              <div><b>${data.Title||nome}</b> <small>(${data.Year||""})</small></div>
              <div><b>IMDb:</b> ${data.imdbRating||""} &nbsp; <b>Tipo:</b> ${data.Type||""}</div>
              <div><b>Gênero:</b> ${data.Genre||""}</div>
              <div><b>Elenco:</b> ${data.Actors||""}</div>
              <div style="margin:10px 0;color:#134072;">${data.Plot||""}</div>
              <button class="iptv-watch" onclick="tocarStream('${url}','${nome}',this);document.getElementById('iptvModal').style.display='none';">ASSISTIR</button>
              <button class="iptv-close" onclick="document.getElementById('iptvModal').style.display='none';">FECHAR</button>`;
      }else{
          el.innerHTML = `<b>${nome}</b><br>
            <div style="color:#ec0;margin:9px 0 20px;">Sem resultados para este nome na OMDb</div>
            <button class="iptv-watch" onclick="tocarStream('${url}','${nome}', this);document.getElementById('iptvModal').style.display='none';">ASSISTIR</button>
            <button class="iptv-close" onclick="document.getElementById('iptvModal').style.display='none';">FECHAR</button>`;
      }
    }
    document.getElementById("iptvModal").onclick = function(e){ if(e.target===this){this.style.display='none';}};
  </script>
</body>
</html>
